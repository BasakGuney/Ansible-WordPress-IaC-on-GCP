
- name: Download Prometheus dashboard JSON to control machine
  get_url:
    url: https://grafana.com/api/dashboards/1860/revisions/34/download
    dest: /tmp/prometheus_dashboard.json


- name: Prepare Grafana dashboard import JSON
  copy:
    dest: /tmp/prom-import.json
    content: |
      {
        "dashboard": {{ lookup('file', '/tmp/prometheus_dashboard.json') | from_json | to_json }},
        "folderId": 0,
        "overwrite": true
      }


- name: Copy dashboard JSON to Grafana server via gcloud
  shell: |
    gcloud compute scp /tmp/prom-import.json {{ prefix }}-log-server:/tmp/prom-import.json --zone {{ gcp_zone }}


- name: Import Prometheus dashboard on Grafana via API
  shell: |
    gcloud compute ssh {{ prefix }}-log-server --zone {{ gcp_zone }} --command '
      curl -s -X POST http://localhost:3000/api/dashboards/db \
        -H "Content-Type: application/json" \
        -H "Authorization: Basic {{ admin_basic_auth }}" \
        -d @/tmp/prom-import.json
    '
  register: prom_dashboard_upload_response


- name: Show dashboard import result
  debug:
    var: prom_dashboard_upload_response.stdout
