- name: Download NGINX Dashboard JSON from grafana.com
  get_url:
    url: https://grafana.com/api/dashboards/12767/revisions/2/download
    dest: /tmp/nginx-dashboard.json


- name: Replace hardcoded datasource UID in dashboard JSON
  replace:
    path: /tmp/nginx-dashboard.json
    regexp: 'DS_PROMETHEUS-[A-Z0-9]+'
    replace: 'DS_PROMETHEUS'


- name: Prepare Grafana dashboard import JSON
  copy:
    dest: /tmp/nginx-import.json
    content: |
      {
        "dashboard": {{
          (lookup('file', '/tmp/nginx-dashboard.json') | from_json) |
          combine({
            "__inputs": [{
              "name": "DS_PROMETHEUS",
              "label": "Prometheus",
              "description": "",
              "type": "datasource",
              "pluginId": "prometheus",
              "pluginName": "Prometheus",
              "value": "{{prometheus_datasource_uid}}"
            }],
            "__templating": {
              "list": [
                {
                  "name": "instance",
                  "type": "query",
                  "datasource": "${DS_PROMETHEUS}",
                  "refresh": 1,
                  "query": "label_values(nginx_up, instance)",
                  "includeAll": false,
                  "multi": false
                }
              ]
            }
          }) | to_json
        }},
        "folderId": 0,
        "overwrite": true
      }


- name: Copy dashboard JSON to Grafana server via gcloud
  shell: |
    gcloud compute scp /tmp/nginx-import.json {{ prefix }}-log-server:/tmp/nginx-import.json --zone {{ gcp_zone }}


- name: Import Nginx dashboard on Grafana via API
  shell: |
    gcloud compute ssh {{ prefix }}-log-server --zone {{ gcp_zone }} --command '
      curl -s -X POST http://localhost:3000/api/dashboards/db \
        -H "Content-Type: application/json" \
        -H "Authorization: Basic {{ admin_basic_auth }}" \
        -d @/tmp/nginx-import.json
    '
  register: nginx_dashboard_upload_response


- name: Show dashboard import result
  debug:
    var: nginx_dashboard_upload_response.stdout
